---
- name: Generate Configurations from NetBox Data
  hosts: all
  gather_facts: yes
  
  vars:
    config_dir: "{{ playbook_dir }}/../configs/generated"
    git_user_email: "awx-{{ awx_job_id }}@frey.example"
    git_user_name: "AWX Job {{ awx_job_id }}"
  
  tasks:
    - name: Configure Git identity
      ansible.builtin.shell: |
        git config --global user.email "{{ git_user_email }}"
        git config --global user.name "{{ git_user_name }}"
      delegate_to: localhost
      run_once: true
      changed_when: false

    - name: Pull latest changes from Git
      ansible.builtin.shell: |
        cd {{ playbook_dir }}/..
        git pull origin {{ scm_branch | default('main') }}
      delegate_to: localhost
      run_once: true
      changed_when: false

    - name: Create generated configs directory
      ansible.builtin.file:
        path: "{{ config_dir }}"
        state: directory
      delegate_to: localhost
      run_once: true

    - name: Verify required NetBox data is present
      ansible.builtin.assert:
        that:
          - inventory_hostname is defined
          - ansible_host is defined
          - netbox_config_context is defined
        fail_msg: |
          Missing required data from NetBox for {{ inventory_hostname }}.
          Ensure device has config context defined in NetBox.
        success_msg: "NetBox data validated for {{ inventory_hostname }}"

    - name: Validate required NetBox config context fields
      ansible.builtin.assert:
        that:
          - netbox_config_context.ntp_servers is defined
          - netbox_config_context.dns_servers is defined
          - netbox_config_context.syslog_servers is defined
        fail_msg: |
          Missing required fields in NetBox config context for {{ inventory_hostname }}.
          Required: ntp_servers, dns_servers, syslog_servers
      when: validate_netbox_data | default(true)

    - name: Display device information from NetBox
      ansible.builtin.debug:
        msg: |
          Device: {{ inventory_hostname }}
          Role: {{ group_names | select('match', '^device_roles_') | map('regex_replace', '^device_roles_', '') | first | default('unknown') }}
          Site: {{ group_names | select('match', '^sites_') | map('regex_replace', '^sites_', '') | first | default('unknown') }}
          Platform: {{ group_names | select('match', '^platforms_') | map('regex_replace', '^platforms_', '') | first | default('unknown') }}

    - name: Set device role fact
      ansible.builtin.set_fact:
        device_role: "{{ group_names | select('match', '^device_roles_') | map('regex_replace', '^device_roles_', '') | first | default('unknown') }}"

    - name: Display what data is available from NetBox
      ansible.builtin.debug:
        msg: |
          NetBox config context data:
          - VLANs: {{ netbox_config_context.vlans | default([]) | length }} configured
          - Interfaces: {{ netbox_config_context.interfaces | default([]) | length }} configured
          - BGP: {{ 'configured' if netbox_config_context.bgp.asn is defined else 'not configured' }}
          - NTP: {{ netbox_config_context.ntp_servers | default([]) | length }} servers
          - DNS: {{ netbox_config_context.dns_servers | default([]) | length }} servers
          - Syslog: {{ netbox_config_context.syslog_servers | default([]) | length }} servers

    - name: Generate configuration from template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/arista_full_config.j2"
        dest: "{{ config_dir }}/{{ inventory_hostname }}.cfg"
      delegate_to: localhost

    - name: Display generated config location
      ansible.builtin.debug:
        msg: "Generated: {{ config_dir }}/{{ inventory_hostname }}.cfg"

    - name: Commit and push generated configs to Git
      ansible.builtin.shell: |
        cd {{ playbook_dir }}/..
        git add configs/generated/
        git diff --staged --quiet || git commit -m "Generated configs from NetBox - {{ ansible_date_time.iso8601 }}"
        git push origin {{ scm_branch | default('main') }}
      delegate_to: localhost
      run_once: true
      register: git_result
      changed_when: "'No changes' not in git_result.stdout"

    - name: Display Git results
      ansible.builtin.debug:
        msg: "Configs committed and pushed to Git"
      run_once: true
      when: git_result.changed