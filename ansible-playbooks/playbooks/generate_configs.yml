---
- name: Generate Configurations from NetBox Data
  hosts: all
  gather_facts: no
  connection: network_cli
  
  vars:
    git_work_dir: "/tmp/ansible-git-work"
    git_repo_url: "{{ git_cfg_repo }}" #Inserted in Job Template definition
    git_branch: main
    git_user_email: "awx-{{ awx_job_id }}@frey.example"
    git_user_name: "AWX Job {{ awx_job_id }}"
    git_username: "{{ lookup('env', 'GITHUB_USERNAME') }}"
    git_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    netbox_api: "{{ lookup('env', 'NETBOX_API')}}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN')}}"
  
  tasks:
    - name: Get timestamp from localhost
      ansible.builtin.setup:
        gather_subset:
          - date_time
      delegate_to: localhost
      run_once: true
      register: localhost_facts

    - name: Set timestamp fact
      ansible.builtin.set_fact:
        current_timestamp: "{{ localhost_facts.ansible_facts.ansible_date_time.iso8601 }}"
      run_once: true

    - name: Configure Git identity
      ansible.builtin.shell: |
        git config --global user.email "{{ git_user_email }}"
        git config --global user.name "{{ git_user_name }}"
      delegate_to: localhost
      run_once: true
      changed_when: false

    - name: Clone repository to working directory
      ansible.builtin.shell: |
        rm -rf {{ git_work_dir }}
        git clone --depth 1 --branch {{ git_branch }} {{ git_repo_url }} {{ git_work_dir }}
      delegate_to: localhost
      run_once: true
      changed_when: false

    - name: Create generated configs directory in git working directory
      ansible.builtin.file:
        path: "{{ git_work_dir }}/configs/generated"
        state: directory
      delegate_to: localhost
      run_once: true

    - name: Verify required NetBox data is present
      ansible.builtin.assert:
        that:
          - inventory_hostname is defined
          - ansible_host is defined
          - config_context is defined
        fail_msg: |
          Missing required data from NetBox for {{ inventory_hostname }}.
          Ensure device has config context defined in NetBox.
        success_msg: "NetBox data validated for {{ inventory_hostname }}"

    - name: Validate required NetBox config context fields
      ansible.builtin.assert:
        that:
          - config_context[0].ntp_servers is defined
          - config_context[0].dns_servers is defined
          - config_context[0].syslog_servers is defined
        fail_msg: |
          Missing required fields in NetBox config context for {{ inventory_hostname }}.
          Required: ntp_servers, dns_servers, syslog_servers
      when: validate_netbox_data | default(true)

    - name: Display device information from NetBox
      ansible.builtin.debug:
        msg: |
          Device: {{ inventory_hostname }}
          Role: {{ group_names | select('match', '^device_roles_') | map('regex_replace', '^device_roles_', '') | first | default('unknown') }}
          Site: {{ group_names | select('match', '^sites_') | map('regex_replace', '^sites_', '') | first | default('unknown') }}
          Platform: {{ group_names | select('match', '^platforms_') | map('regex_replace', '^platforms_', '') | first | default('unknown') }}

    - name: Set device role fact
      ansible.builtin.set_fact:
        device_role: "{{ group_names | select('match', '^device_roles_') | map('regex_replace', '^device_roles_', '') | first | default('unknown') }}"

    - name: Display what data is available from NetBox
      ansible.builtin.debug:
        msg: |
          NetBox config context data:
          - BGP: {{ 'configured' if config_context[0].bgp.asn is defined else 'not configured' }}
          - NTP: {{ config_context[0].ntp_servers | default([]) | length }} servers
          - DNS: {{ config_context[0].dns_servers | default([]) | length }} servers
          - Syslog: {{ config_context[0].syslog_servers | default([]) | length }} servers

    - name: Obtain a list of VLANs from NetBox and save to a variable
      ansible.builtin.set_fact:
        vlans: "{{ query('netbox.netbox.nb_lookup',validate_certs=false,'vlans',api_endpoint=vars['netbox_api'],token=vars['netbox_token']) }}"

    - name: Display list of VLANs for debugging
      ansible.builtin.debug:
        msg: "{{ vlans }}"

    - name: Generate configuration from template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/arista_full_config.j2"
        dest: "{{ git_work_dir }}/configs/generated/{{ inventory_hostname }}.cfg"
      delegate_to: localhost

    - name: Display generated config location
      ansible.builtin.debug:
        msg: "Generated: {{ git_work_dir }}/configs/generated/{{ inventory_hostname }}.cfg"

    - name: Commit and push generated configs to Git
      ansible.builtin.shell: |
        cd {{ git_work_dir }}
        git add configs/generated/
        if git diff --staged --quiet; then
          echo "no_changes"
          exit 0
        fi
        git commit -m "Generated configs from NetBox - {{ current_timestamp }}"
        git remote set-url origin https://{{ git_username }}:{{ git_token }}@{{ git_repo_url[8:] }} # Strip https:// from git_repo_url 
        git push origin {{ git_branch }}
      delegate_to: localhost
      run_once: true
      register: git_result
      changed_when: "'no_changes' not in git_result.stdout"
      no_log: true
      timeout: 60

    - name: Display Git results
      ansible.builtin.debug:
        msg: "Configs committed and pushed to Git"
      run_once: true
      when: git_result.changed

    - name: Cleanup working directory
      ansible.builtin.file:
        path: "{{ git_work_dir }}"
        state: absent
      delegate_to: localhost
      run_once: true
      when: cleanup_git_work_dir | default(true)